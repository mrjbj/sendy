version: "3.7"

# Volumes for persisted data.
volumes:
  data_sendy:
    labels:
      co.sendy.description: "Data volume for Sendy Database."

# Secret files so they're not exposed via 'docker inspect'
secrets:
  db_password:
    file: secrets/db_password
  db_root_password:
    file: secrets/db_root_password

services:
  # Database: MySQL
  db_sendy:
    hostname: db_sendy
    container_name: db_sendy
    image: mysql:5.6
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      MYSQL_DATABASE: ${MYSQL_DATABASE}
      MYSQL_USER: ${MYSQL_USER}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD}
      MYSQL_DEFAULT_AUTH: mysql_native_password
    secrets:
      - db_root_password
      - db_password
    volumes:
      - data_sendy:/var/lib/mysql

  # WebApp: Apache2+PHP+Sendy
  sendy:
    hostname: sendy
    container_name: sendy
    depends_on:
      - db_sendy
    image: sendy:latest
    build:
      context: .
      # Uncomment to enabled XDEBUG build
      # target: debug
    environment:
      MYSQL_DATABASE: ${MYSQL_DATABASE}
      MYSQL_USER: ${MYSQL_USER}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD}
      MYSQL_HOST: db_sendy
      SENDY_PROTOCOL: ${SENDY_PROTOCOL}
      SENDY_FQDN: ${SENDY_FQDN}
    ports:
      - 3001:80

  # Load Balancer: HAProxy
  # load-balancer:
  #   hostname: lb_sendy
  #   container_name: lb_sendy
  #   image: lb_sendy
  #   build:
  #     context: .
  #     dockerfile: haproxy/Dockerfile
  #   env_file:
  #     - sendy.env
  #   ports:
  #     - 80:80
  #     - 443:443
